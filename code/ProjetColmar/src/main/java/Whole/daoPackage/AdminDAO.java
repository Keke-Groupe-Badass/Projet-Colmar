/*
 * This code has been generated by the Rebel: a code generator for modern Java.
 *
 * Drop us a line or two at feedback@archetypesoftware.com: we would love to hear from you!
 */
package Whole.daoPackage;

import Whole.LinkToDb;
import Whole.exportPackage.ExportSQL;
import Whole.exportPackage.ExportTypeInterface;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.sql.*;
import java.util.ArrayList;

/**
 * Classe permettant à l'administrateur de gérer la base de donnée
 */
public class AdminDAO {

    /**
     * Constructeur de la classe
     */
    private ArrayList<ExportTypeInterface> listeMethode;
    private ArrayList<String> listeTable;
    public AdminDAO() {
    }

    /**
     * Permet de stocker dans un fichier la bd
     * @param file le fichier où sera exporter les données
     * @param cn La connection à la base de donnée
     * @see LinkToDb
     * @see Whole.exportPackage.ExportTypeInterface
     *
     */


    public Boolean exportDonee(File file,Connection cn, String methode, String path)  {
        for(ExportTypeInterface e:listeMethode){
            if(e.getName().equals(methode)){
                if(e.getName().equals("SQL")){
                    String os = System.getProperty("os.name");
                    String type="sh";
                    if(os.contains("Windows")){
                        type="cmd.exe";
                    }
                    String[] cmd = { type, "exportSQL.sh", "src/main/shell/exportSQL.sh"};
                    try {
                        Runtime.getRuntime().exec(cmd);
                    } catch (IOException ex) {
                        return false;
                    }
                }
                else{
                    Boolean b = true;
                    ArrayList<ArrayList<String>> list;
                    for(String st:listeTable){
                        list=getTableList(st,cn);
                        File f = new File(path+"/"+st);
                        b = b && e.export(f,list );
                    }
                    return b;

                }
            }
        }
        return false;
    }

    /**
     * Permet de transformer une table en une liste de liste, le premier niveau de liste représentant les lignes
     * et le second niveau les colones, la première ligne est le nom des colones.
     * @param table la table que l'on souhaite exporter
     * @param cn la connection
     * @return true si tout c'est bien passé, false sinon
     */
    public ArrayList<ArrayList<String>> getTableList(String table,Connection cn){
        ArrayList<ArrayList<String>> list= new ArrayList<>();
        try {
            Statement stmt = cn.createStatement();

            ResultSet rs= stmt.executeQuery("SELECT * FROM "+table);
            ResultSetMetaData md =  rs.getMetaData();
            int size =md.getColumnCount();
            for(int i=0;i<size;i++){
                list.get(0).add(md.getColumnName(i));
            }
            while(rs.next()){
                int row=1;
                for(int j=0;j<row;j++){
                    for(int i=0;i<size;i++){
                        list.get(j).add(md.getColumnName(i));
                    }
                }
                row++;
            }
        } catch (SQLException e) {

        }
        return list;
    }


    /**
     * Permet de stocker dans un fichier les logs
     * @param cn La connection à la base de donnée
     * @param file le fichier où sera exporter les log
     * @see LinkToDb
     */


    public Boolean exportLog(File file,Connection cn)  {
        try {
            Statement stmt = cn.createStatement();
            ResultSet rs = stmt.executeQuery("SELECT `text`,`date`,`userLogin` FROM `log`");
            String str = "Hello";
            BufferedWriter bw = new BufferedWriter(new FileWriter(file));
            bw.write("Log exporté le "+System.currentTimeMillis());

            while(rs.next()){
                bw.newLine();
                str=rs.getString(2)+" par "+rs.getString(3)+": "+rs.getString(1);
                bw.write(str);

            }
            bw.close();

        }catch(SQLException e){
            System.err.println("something went wrong with the database link");
        } catch (IOException e) {
            System.err.println("something went wrong with the writing of the file");

        }
        return false;
    }

    /**
     * Supprime les logs de la bd
     * @param cn La connection à la base de donnée
     * @see LinkToDb
     *
     */
    public Boolean deleteLog(Connection cn) {
        Statement stm = null;
        try {
            stm = cn.createStatement();
            stm.execute("DELETE FROM `log`");
            return true;
        } catch (SQLException e) {
            System.err.println("something went wrong with the database link");
        }
        return false;
    }

    /**
     * Ajoute au log un text
     * @param txt Le message à enregistrer
     * @param user L'utilisateur qui a provoqué une action
     * @param cn La connection à la base de donnée
     * @return true si l'insertion peut se faire, false sinon
     * @see LinkToDb
     */
    public Boolean writeLog(String txt, String user,Connection cn){
        try {
            Statement st = cn.createStatement();
            st.execute("INSERT INTO `log`( `text`, `date`, `userLogin`) VALUES('"+txt+"','"+new Date( System.currentTimeMillis())+"','"+user+"'");
            return true;
        } catch (SQLException e) {

        }
        return false;

    }

}